# 현재 위치 배포와 블루 그린 배포

> AWS 인프라 구축 가이드(김담형 저)를 참고하여 작성함

### 무중단/중단

배포를 할 때 서비스를 중단할지 말지의 차이를 가진다. 당연히 사용자 측면을 고려하면 무중단 배포를 해야하는 것이 아닌가 싶지만, 무중단 배포 시 비용이 큰 경우가 있다.<br>
예를 들어, 기존의 a, b 기능에 영향을 주지 않는 c기능을 추가한 경우라면 무중단 배포를 해도 문제가 없다.<br>
그러나 기능 b가 사용하는 테이블이 다른 테이블로 변경된 경우에는, 기존 테이블을 사용하는 서비스와 바뀐 테이블을 사용하는 서비스가 서버에 동시에 떠있다면
데이터베이스의 정합성이 깨지게 된다. 이 같은 경우 중단 배포를 하거나 무중단 배포를 위해 변경사항을 임시로 저장해두는 테이블을 만들어 차이 값을 마이그레이션 하는 방법을 택해야 한다.

### 현재 위치 배포(In-place deployment)

무중단 배포를 위한 기법 중 하나.<br>
여러 대의 서버를 배포할 때 새롭게 서버를 생성하거나 줄이지 않고 배포하는 방법이다.<br>
예를 들어, 4대의 서버가 있고 로드 밸런서가 클라이언트 요청을 고르게 나눠주고 있다고 하자.<br>
모든 서버는 v1.0.0를 서비스하고 있고, 이번에 v1.0.1를 배포하려고 한다.<br>

1. 먼저 4대 중 2대의 인스턴스를 로드밸런서에서 제거한다.
2. 제외된 인스턴스에 새 버전인 v1.0.1의 코드를 배포한다.
3. v1.0.1이 배포된 서버를 다시 로드밸런서에 등록한다. 그리고 v1.0.0을 서비스하던 인스턴스는 로드밸런서에서 제외한다.
4. 제외된 두 개의 인스턴스에도 v1.0.1의 코드를 배포하고 로드밸런서에 다시 등록한다.

- 장점: 간단하고 빨리 진행할 수 있음
- 단점: 배포 중에는 클라이언트의 요청을 처리할 수 있는 인스턴스의 수가 적어짐/새로 배포한 버전에 문제가 있어 롤백하는 경우 대응 오래걸림

### 블루/그린 배포(Blue/Green Deployment)

블루/그린 배포 역시 무중단 배포를 위한 기법 중 하나이다.<br>
예를 들어, 2대의 서버로 요청을 처리하고 있고 마찬가지로 새 버전인 v1.0.1을 배포하기로 한 상황을 가정하자.<br>
블루 그린 배포는 2개의 그룹으로 진행된다. 기존 버전인 v1.0.0으로 서비스 되고 있는 서버들은 **블루** 그룹에 존재한다.<br>

1. 아무런 서버도 갖고 있지 않은 **그린** 그룹에 블루 그룹과 똑같은 수의 인스턴스를 생성하고 v1.0.1을 배포한다.
2. 배포가 완료되면 그린 그룹도 로드밸런서에 등록하여 요청을 블루 그룹과 나눠 처리하도록 한다.
3. 로드밸런서에 블루 그룹을 제외하여 모든 요청을 그린그룹에서 처리하도록 한다.
4. 블루 그룹의 인스턴스를 모두 종료하여 배포를 완료한다.
5. 다음에 새로운 버전을 배포한다면, 블루 그룹에 새로운 버전을 배포하고 그린 그룹의 인스턴스를 종료하면 된다.

- 장점
  - 신/구버전이 동시에 떠있는 시간을 매우 짧게 처리할 수 있음(새로운 버전을 배포한 서버가 미리 준비되어 있음)
  - 롤백을 빨리할 수 있음
  - 배포 과정에서 서비스되는 인스턴스의 수가 줄어들지 않음.
