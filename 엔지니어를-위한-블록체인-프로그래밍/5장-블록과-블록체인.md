*엔지니어를 위한 블록체인 프로그래밍(다고모리 데루히로 저)를 정리한 글입니다*

# 블록과 블록체인
> 각각의 블록은 링크 구조를 가진다. 새로 추가된 블록은 이 링크의 끝에 위치한다. 각 블록은 그 앞에 위치한 블록(부모 블록)으로 연결되는 링크를 갖고 있다.

###  블록의 구조
- 블록의 구조

필드 | 필드 크기(byte) | 설명
-|-|-
Block Size | 4 | 이 필드를 제외한 블록의 데이터 크기(byte)
Block Header | 80 | 블록 헤더 정보
Transaction Counter | 1~9 | 블록에 포함된 거래의 수
Transactions | 가변적 | 거래의 목록

- 블록 헤더의 구조

필드 | 필드 크기(byte) | 설명
-|-|-
Version | 4| 프로토콜 버전 정보
Previous Block Hash | 32 | 부모 블록의 해시값
Merkle Root | 32 | 머클트리 루트의 해시값
Timestamp | 4| 블록을 생성한 시간(unixtime)
Difficulty Target|4| 블록을 생성할 때 PoW의 난이도
Nonce | 4 | PoW에서 사용하는 카운터

\* Pow(Proof of Work): 작업증명. 해시연산을 처리하는 하드웨어(GPU, ASIC 채굴기)를 사용해 코인을 채굴하는 것.

### 블록의 식별자
블록체인 안에서 블록의 식별자는 **블록 해시** 와 **블록 높이** 값이다.
- 블록 해시는 블록 헤더를 SHA-256으로 2번 해싱한 값으로, 보든 블록이 고유한 값을 갖는다.

- 블록 높이는 해당 블록의 블록체인 내 위치이다. genesis 블록(첫번째 블록)은 블록 높이가 0이고, 그 다음 블록부터 1씩 증가한다. 블록 높이만으로는 블록을 특정할 수 없는 경우도 있다.

### 블록 안의 거래 검색하기
블록체인은 과거의 모든 거래에 대한 정보를 포함하기 때문에 데이터의 크기가 매우 크다. 따라서 거래를 직접 저장하는 블록 대신 블록 헤더만 저장하는 노드인 SPV 노드가 있다. 과거의 모든 블록으로 구성된 블록체인인 풀블록체인에 비해, 크기가 1/1000로 줄어들어 저장 용량도 크게 줄어든다. 풀블록체인을 저장하는 노드라면 모든 블록을 검색할 수 있지만, SPV노드는 모든 블록을 검색할 수 없다. 따라서 SPV 노드에서 특정 거래가 블록에 포함되어 있는지 확인하기 위해서 **머클 트리(Merkle Tree)** 를 사용한다.

- 머클 트리(Merkle Tree)

머클 트리는 대규모의 데이터를 효율적으로 요약하고 검증하는 이진 트리 기반의 데이터 구조로, 블록 안에 저장된 거래 모두에 대해 디지털 지문을 만들어 어떤 거래가 블록에 저장되었는지 검색할 수 있도록 한다.

- 머클 트리 구축 과정

아래의 그림과 같이 각 거래의 해시값(Hash 0-0, 0-1, 1-0, 1-1)을 모은다. 인접한 leaf node 쌍을 연결하고, 이에 대해 SHA-256 이중 해싱 값을 계산하여 새로운 노드를 생성한다. 이 과정을 재귀적으로 반복한다. 마지막에 남은 하나의 해시값이 블록 헤더의 필드인 **Merkle Root** 이다.

![머클 트리 구축 방법](https://miro.medium.com/max/1174/1*prtcx2rVQZmX9oZcyrC_gQ.png)

머클 트리는 이진 트리이므로 거래 수가 짝수여야 하는데, 거래 수가 홀수인 경우 거래를 하나 복제하여 짝수로 만든다. 위의 그림에서 Data block인 L4가 없다고 가정하면, L4 자리에 L3를 복제해두는 것과 같다.<br/>


- 머클 경로(Merkle Path)로 검증하기

머클 트리를 이용해 특정한 앞 노드가 존재하는지 증명하려면 머클 경로를 만든다. SPV 노드는 풀블록체인을 저장해둔 노드에서 머클 경로와 블록 헤더를 전달받아 거래가 블록에 포함되어 있는지 확인할 수 있다.

![머클 경로로 검증](https://www.mycryptopedia.com/wp-content/uploads/2017/11/Merkle-tree.jpg)

위 그림에서 머클 루트인 H(ABCDEFGH) 값과 H(C) 값만 가지고 있을 때, C라는 거래가 진짜인지 확인해야 한다. 풀블록체인을 저장해둔 노드로부터 H(D), H(AB), H(EFGH)의 정보를 받아 해시 함수에 차례대로 넣어 계산한다. 상대값을 알게되어 머클 트리를 진행할 수 있는데, 이때 경로가 머클 경로이다. 계산한 최종 결과가 머클 루트인 H(ABCDEFGH)값이 동일하다면 진짜이고 그렇지 않으면 거짓 거래인 것으로 검증할 수 있다.
